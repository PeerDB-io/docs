## Real-time CDC from Postgres to BigQuery or Snowflake

PeerDB introduces **CREATE MIRROR for streaming changes,** to enable Real-time Change Data Capture (CDC) from Postres to any of Snowflake or BigQuery. 
1. You just run a few SQL command and PeerDB takes up all the heavy-lifting to setup and maintain highly performant and a resilient real-time sync between the stores. 
> SQL commands makes it super easy and intuitive to develop data-pipelines in our test, dev and prod environments. 
>
2. In our initial benchmarks we observed over 10x performance gains vs other tools. Average lag for a workload that generates 1000 tps on Postgres was around 30 seconds.


### Scenario

Suppose you have a banking application running on Postgres. There are 2 tables users and transactions. You want to sync these tables in real-time to BigQuery for analytics purposes - for example, say real-time fraud detection. Let us see how we can make this happen within a few minutes and a few SQL command using PeerDB.

### Pre-requisites

1. Enable Postgres with logical decoding. Ensure that the below settings/GUCs are configured properly on Postgres.
    1. wal_level: logical
    2. max_wal_senders: >1
    3. max_replication_slots: 4
2. Enable replication access to a postgres user - ALTER USER pg_user REPLICATION;
3. Ensure that both the tables have primary keys. Composite primary are also fine.

### Step 1: Add Postgres and BigQuery Peers

Run the below commands to let PeerDB know of the existing Postgres and BigQuery Peers.

```sql
-- Add Postgres and BigQuery peers
CREATE PEER postgres_peer FROM postgres (...);
CREATE PEER bigquery_peer FROM bigquery (...);
```

Make sure to replace **`(…)`** with the appropriate connection details for both the Postgres and BigQuery instances. More details on adding PEERs available [here](https://docs.peerdb.io/sql/commands/create-peer)

### **Step 2: Real-Time CDC from Postgres to BigQuery**

With the peers set up, you can create a mirror that facilitates real-time CDC from Postgres to BigQuery. 

```sql
-- Real-time CDC from Postgres to BigQuery
CREATE MIRROR real_time_cdc
FROM postgres_peer TO bigquery_peer
WITH TABLE MAPPING transactions:transactions, users:users
WITH OPTIONS ();
```

If you observe, **TABLE MAPPING** represents the table name mapping between Postgres and BigQuery.  PeerDB automatically creates the table with suitable data-type mapping on the target. PeerDB supports 30+ postgres native data-types for CREATE MIRROR. These data-types are chosen in a way that there is loss of data (ex: precision) as a part of the real-time sync.

1. Data-type mapping between [Postgres and BigQuery](https://github.com/PeerDB-io/peerdb/pull/89#issue-1737252747)
2. Data-type mapping between [Postgres and Snowflake](https://github.com/PeerDB-io/peerdb/pull/104)
3. If you wanted extra types to be supported or alter the existing data-type mapping, please reach out to us. We can aim to support that within few day(s). Also PeerDB is [fully open source](https://github.com/PeerDB-io/peerdb). So feel free to submit a PR.

> **PeerDB also supports replicating TOAST columns very efficiently**. Unlike most CDC tools, you don’t need to setup REPLICA IDENTITY FULL for replicating TOAST columns. This [PR](https://github.com/PeerDB-io/peerdb/pull/111) captures the infrastructural optimizations that PeerDB takes to support TOAST columns.
> 

### **Step 3: Validate the Mirror**

Through the same PeerDB’s Postgres-compatible SQL interface, you can quickly validate the MIRROR (real-time CDC)

```sql
-- Validate the mirror
SELECT COUNT(*) FROM bigquery_peer.events;
SELECT COUNT(*) FROM postgres_peer.public.events;
```

### Step 4: Monitor the MIRROR

You can connect to [localhost:8233](http://localhost:8233) to get full visibility into the different jobs and steps that PeerDB is taking under the covers to manage the MIRROR.

![Managing Mirror](../images/managing_mirror.png)

### Step 5: DROP MIRROR

To make it easy in your dev and test environments, PeerDB also introduces the DROP MIRROR command. DROP MIRROR drops all the underlying objects that CREATE MIRROR generates. More details in this [PR](https://github.com/PeerDB-io/peerdb/pull/93).

```sql
-- drop the mirror
DROP MIRROR real_time_cdc;
```

### Coming Soon

1. Blazing fast initial load - parallelism within a table and across tables will be available in a few weeks.
2. Support for tables without primary keys using UNIQUE index or [REPLICA IDENTITY FULL](https://www.notion.so/f0e258f310dc4231ad35b6a210f7d4b1?pvs=21) will be added in a few weeks.
3. Handling Schema Changes will be added in a few weeks.

